# The test template for testing misc configurations:
# - disk
# - snapshots
# - (More to come)
#
base: template:ubuntu-22.04

# 9p is not compatible with `limactl snapshot`
mountTypesUnsupported: ["9p"]
mounts:
- location: "~"
  writable: true
- location: "/tmp/lima test dir with spaces"
  writable: true

param:
  ANSIBLE: ansible
  BOOT: boot
  DEPENDENCY: dependency
  PROBE: probe
  SYSTEM: system
  USER: user
  YQ: yq

provision:
- mode: ansible
  playbook: ./hack/ansible-test.yaml
- mode: boot
  script: "touch /tmp/param-$PARAM_BOOT"
- mode: dependency
  script: "touch /tmp/param-$PARAM_DEPENDENCY"
- mode: system
  script: |
    touch /tmp/param-$PARAM_SYSTEM

    # port forwarding test setup
    apt-get update
    apt-get install -y nginx python3
    systemctl enable nginx
    systemctl start nginx

    cat > /etc/systemd/system/test-server-9080.service << 'EOF'
    [Unit]
    Description=Test Server on Port 9080
    After=network.target

    [Service]
    Type=simple
    User=root
    ExecStart=/usr/bin/python3 -m http.server 9080 --bind 127.0.0.1
    Restart=always

    [Install]
    WantedBy=multi-user.target
    EOF

    cat > /etc/systemd/system/test-server-9070.service << 'EOF'
    [Unit]
    Description=Test Server on Port 9070
    After=network.target

    [Service]
    Type=simple
    User=root
    ExecStart=/usr/bin/python3 -m http.server 9070 --bind 127.0.0.1
    Restart=always

    [Install]
    WantedBy=multi-user.target
    EOF

    mkdir -p /var/www/html-9080
    mkdir -p /var/www/html-9070

    echo '<html><body><h1>Dynamic port 9080</h1></body></html>' > /var/www/html-9080/index.html
    echo '<html><body><h1>Dynamic port 9070</h1></body></html>' > /var/www/html-9070/index.html

    systemctl daemon-reload
    systemctl enable test-server-9080
    systemctl enable test-server-9070
    systemctl start test-server-9080
    systemctl start test-server-9070

- mode: user
  script: "touch /tmp/param-$PARAM_USER"
- mode: data
  path: /etc/sysctl.d/99-inotify.conf
  content: |
    fs.inotify.max_user_watches = 524288
    fs.inotify.max_user_instances = 512
- mode: yq
  path: "/tmp/param-{{.Param.YQ}}.json"
  expression: .YQ = "{{.Param.YQ}}"

probes:
- mode: readiness
  script: |
    #!/bin/sh
    touch /tmp/param-$PARAM_PROBE

# in order to use this example, you must first create the disks. run:
# $ limactl disk create data --size 10G
# $ limactl disk create swap --size 2G
additionalDisks:
- "data"
- name: "swap"
  format: true
  fsType: swap

user:
  name: john
  comment: John Doe
  home: "/home/{{.User}}-{{.User}}"
  uid: 4711
  # Ubuntu has identical /bin/bash and /usr/bin/bash
  shell: /usr/bin/bash

portForwards:
- guestPort: 80
  hostPort: 9090
  static: true
- guestPort: 9080
  hostPort: 29080
  static: false
- guestPort: 9070
  hostPort: 29070
  static: false
