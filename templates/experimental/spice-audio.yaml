# Example: QEMU with SPICE display and audio
# This template demonstrates SPICE protocol with audio streaming support

# VM type must be qemu for SPICE support
vmType: qemu

# SPICE display configuration
video:
  # SPICE display with basic settings
  # For production, consider using password protection or TLS
  display: "spice,port=5930,addr=127.0.0.1,disable-ticketing=on"

  # SPICE-specific options
  spice:
    # Enable audio streaming over SPICE
    audio: true
    # Enable OpenGL acceleration (requires spice-app or gl=on in display)
    gl: false
    # Enable SPICE agent for enhanced integration
    agent: true
    # Streaming video mode: "off", "all", or "filter"
    streamingVideo: "filter"

# Audio device configuration
audio:
  # Use "default" for platform audio (coreaudio on macOS, pulseaudio on Linux)
  # When SPICE audio is enabled, this will use SPICE audiodev instead
  device: "default"

# Standard VM configuration
images:
- location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-amd64.img"
  arch: "x86_64"
- location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img"
  arch: "aarch64"

cpus: 4
memory: "4GiB"
disk: "30GiB"

mounts:
- location: "~"
- location: "/tmp/lima"
  writable: true

# SSH configuration
ssh:
  localPort: 0
  loadDotSSHPubKeys: true

# Firmware: Use UEFI
firmware:
  legacyBIOS: false

# Provision scripts
provision:
- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail
    # Install audio utilities for testing
    apt-get update
    apt-get install -y alsa-utils pulseaudio
- mode: user
  script: |
    #!/bin/bash
    set -eux -o pipefail
    echo "SPICE display and audio are configured"
    echo "Connect with: remote-viewer spice://127.0.0.1:5930"
    echo ""
    echo "Audio testing commands:"
    echo "  speaker-test -t wav -c 2  # Test audio output"
    echo "  arecord -d 5 test.wav     # Test audio input (microphone)"

# Host resolver
hostResolver:
  enabled: true

# Port forwarding
portForwards:
- guestSocket: "/run/user/{{.UID}}/podman/podman.sock"
  hostSocket: "{{.Dir}}/sock/podman.sock"

# Message to display after instance is created
message: |
  ====================================================================
  SPICE Display and Audio Enabled
  ====================================================================

  To connect to the graphical display:
    remote-viewer spice://127.0.0.1:5930

  SPICE Viewer Required:
    macOS: brew install virt-viewer
    Linux: sudo apt-get install virt-viewer (Ubuntu/Debian)
           sudo dnf install virt-viewer (Fedora/RHEL)

  Audio Testing:
    # Inside the VM, test audio output:
    speaker-test -t wav -c 2

    # Test audio input (if configured):
    arecord -d 5 test.wav && aplay test.wav

  Configuration:
    Display: {{.Video.Display}}
    Audio: SPICE streaming (enabled)
  ====================================================================
